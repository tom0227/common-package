name: Publish Private Packages

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed

jobs:
  publish:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚ã€ã¾ãŸã¯mainãƒ–ãƒ©ãƒ³ãƒã«ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        package:
          - auth-rbac
          - config-common
          - shared-modules
          - test-utils
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@tom0227'
      
      - name: Configure npm for GitHub Packages
        run: |
          echo "@tom0227:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
      
      - name: Update package name and version
        working-directory: ./${{ matrix.package }}
        run: |
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã«ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¿½åŠ 
          npm pkg set name="@tom0227/${{ matrix.package }}"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
          npm version patch --no-git-tag-version
          
          # GitHub Packagesã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªè¨­å®š
          npm pkg set publishConfig.registry="https://npm.pkg.github.com"
          npm pkg set publishConfig.access="restricted"
      
      - name: Install dependencies
        working-directory: ./${{ matrix.package }}
        run: npm ci
      
      - name: Build package
        working-directory: ./${{ matrix.package }}
        run: |
          if [ -f "tsconfig.json" ]; then
            npm run build || echo "No build script found"
          fi
      
      - name: Run tests
        working-directory: ./${{ matrix.package }}
        run: |
          npm test || echo "No test script found"
      
      - name: Publish to GitHub Packages
        working-directory: ./${{ matrix.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm publish
      
      - name: Create release tag
        if: success()
        run: |
          VERSION=$(node -p "require('./${{ matrix.package }}/package.json').version")
          git tag "${{ matrix.package }}-v${VERSION}"
          git push origin "${{ matrix.package }}-v${VERSION}" || echo "Tag already exists"

  notify:
    needs: publish
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify success
        if: needs.publish.result == 'success'
        run: |
          echo "âœ… All packages have been successfully published to GitHub Packages!"
          echo "ğŸ“¦ Published packages:"
          echo "  - @tom0227/auth-rbac"
          echo "  - @tom0227/config-common"
          echo "  - @tom0227/shared-modules"
          echo "  - @tom0227/test-utils"